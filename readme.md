


# 使用QGIS修正Polygon中的错误
### 1. 准备工作
#### 1.1 安装QGIS
+ QGIS下载地址

    http://www.qgis.org/en/site/forusers/download.html

+ 语言设置（可选）

启动 `QGIS Desktop *.*.* with GRASS *.*`，如果默认语言为英文，可以通过菜单设定为中文：

  `Settings`->`Options`->`Locale`，在下拉菜单中修改语言为`简体中文`

保存后退出，再启动后就是中文菜单了。

 ![image](http://github.com/asdawn/fix-geometry/raw/master/images/01-language.png)

#### 1.2 准备多边形数据文件

将多边形的WKT存入`TAB`（制表符）分隔的带表头的.txt文件中，每行一个，如下所示(请自行将分隔符由`|`替换为`TAB`)：

    ID|WKT
    001|POLYGON ((118.7219 32.168959,118.720678 32.164863,118.720103 32.161806,118.719744 32.158261,118.720175 32.156121,118.716438 32.156671,118.715072 32.156671,118.710473 32.156854,118.70803 32.156732,118.706233 32.15661,118.702927 32.155754,118.704365 32.153003,118.705011 32.151474,118.705586 32.150374,118.707024 32.148601,118.708605 32.14695,118.706736 32.146461,118.708892 32.142119,118.710976 32.139857,118.715001 32.137105,118.72578 32.147745,118.727074 32.146155,118.731314 32.151413,118.733613 32.155265,118.734979 32.157588,118.735266 32.159911,118.735841 32.164435,118.736344 32.165963,118.72154 32.16902,118.7219 32.168959))
    002|POLYGON ((1 1,2 2,2 1,1 1))

### 2. 多边形检验与处理

#### 2.1 加载多边形数据文件

在QGIS左侧图标寻找`添加文本数据图层`（  ![image](http://github.com/asdawn/fix-geometry/raw/master/images/02-wkt.png)），然后加载多边形数据文件，注意分隔符（制表符）、表头（首行包含字段名称）以及几何图形定义（WKT）选项，之后按照默认值即可加载多边形数据到地图上。

 ![image](http://github.com/asdawn/fix-geometry/raw/master/images/03-wkt-1.png)

    注意：由于示例数据比较随意，加载后可能只能看到一个三角形，这个没有问题，不影响本教程，请继续。

#### 2.1 检验并另存有问题的多边形

菜单`矢量`->`几何图形工具`->`检查有效性`，启动检查工具。请选择设定好`输出有效`、`输出无效`的输出文件（例如 *d:\\valid.shp*和*d:\\invalid.shp* ，可以用左侧的`添加矢量图层`图标打开），以便将来保存起来进行后续处理。

此时有一个名为`输出无效`的图层，右键点击选择`缩放到图层范围`，即可看到它包含的多边形，以及出问题的位置（有提示的点）。

#### 2.2 修复有问题的多边形

菜单菜单`处理`->`工具箱`，在出现的工具箱区域搜索`v.clean`，在搜索结果中双击启用该工具。`Layer to clean`选择要处理的图层，然后`Threahold`设定为0.0001（0.0001°大约为10米，必要时可自行调整），然后`run`，得到清理后的图层（默认名为`cleaned`）。
 ![image](http://github.com/asdawn/fix-geometry/raw/master/images/04-cleaned.png)


此时已经修正了几何形状自相交的错误，但并未删除误操作绘制的那个极小的多边形，因为程序并不知道哪个是有用的。

#### 2.4 删除小多边形

此处假设那些极小的多边形是误操作绘制的，清除掉即可。在`图层面板`右键点击修正的图层，选择`打开属性表`，选择窗口上的`打开字段计算器`图标（一般是倒数第二个），然后去掉`仅更新选中要素`的对勾，`输出字段名称`为*area*，表达式部分设定为

    $area
![image](http://github.com/asdawn/fix-geometry/raw/master/images/05-area.png)


然后执行计算，就可以看到每个多边形的面积（单位自动切换为平方米），可以按照面积进行排序，选择面积过小的多边形（例如几平米、低于50平米的，地图上有高亮显示，可自行判断阈值），删除它们（通过`delete selected feature`图标，第6个），然后保存编辑（通过`切换编辑模式`图标，第1个），关闭属性表预览窗口。之后在`图层面板`右键另存图层为shp或者geojson文件即可。

#### 3. 更新数据

geojson格式中有坐标数组属性，可以自行解析或者使用我方提供的geojson转wkt服务。我方也可提供shp文件到wkt文本文件的转换工具，或者代为转换。

根据ID，可以替换掉旧的有问题的边界数据。请注意数据备份，避免误操作等带来问题。
